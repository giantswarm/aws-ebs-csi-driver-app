apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
# CRDs
- upstream/client/config/crd
# Snapshot controller
- upstream/deploy/kubernetes/snapshot-controller

namespace: "{{ .Release.Namespace }}"

labels:
# Common labels
- pairs:
    helm.sh/chart: aws-ebs-csi-driver-app
    app.kubernetes.io/name: snapshot-controller
    app.kubernetes.io/instance: "{{ .Release.Name }}"
    app.kubernetes.io/version: "{{ .Chart.AppVersion }}"
    app.kubernetes.io/managed-by: "{{ .Release.Service }}"
    giantswarm.io/service-type: managed
    application.giantswarm.io/team: phoenix
  includeTemplates: true

images:
- name: registry.k8s.io/sig-storage/snapshot-controller
  newName: gsoci.azurecr.io/giantswarm/snapshot-controller

patches:
- target:
    kind: CustomResourceDefinition
  patch: |-
    - op: add
      path: /metadata/annotations/helm.sh~1resource-policy
      value: keep
- target:
    kind: ServiceAccount
    name: snapshot-controller
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        eks.amazonaws.com/role-arn: '{{ .Values.clusterID }}-ebs-csi-driver-role'
- target:
    kind: Deployment
    name: snapshot-controller
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: snapshot-controller
    spec:
      template:
        spec:
          containers:
          - name: snapshot-controller
            securityContext:
              runAsNonRoot: true
              runAsUser: 65534
              runAsGroup: 65534
              allowPrivilegeEscalation: false
              seccompProfile:
                type: RuntimeDefault
              capabilities:
                drop:
                - ALL
              readOnlyRootFilesystem: true
